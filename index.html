<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventi sulla Mappa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>

    <h1>Eventi sulla Mappa</h1>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Inizializza la mappa
        var map = L.map('map').setView([41.9028, 12.4964], 6); // Italia

        // Aggiungi il layer di OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Funzione per ottenere i dati CSV
        function fetchData() {
            var url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsC2LtvXVVBz1ffZqYpSXEUwb2z_27GF0zYLZkABhhcmBHQ8U0axgwoELKeUcGSAZhdWbKopHdvvnA/pub?output=csv';

            fetch(url)
                .then(response => response.text())
                .then(csvText => {
                    // Converti CSV in array di oggetti
                    var data = csvToArray(csvText);
                    
                    data.forEach(entry => {
                        var name = entry["Nome Evento"];
                        var address = entry["Indirizzo"];
                        var lat = parseFloat(entry["Latitudine"]);
                        var lon = parseFloat(entry["Longitudine"]);
                        var description = entry["Descrizione"];
                        var ticketLink = entry["Link Biglietti"];
                        var eventDate = entry["Data Evento"];

                        // Crea il contenuto per il popup
                        var popupContent = `
                            <strong>${name}</strong><br>
                            <em>${address}</em><br>
                            <strong>Data evento:</strong> ${eventDate}<br>
                            <strong>Descrizione:</strong> ${description}<br>
                            <a href="${ticketLink}" target="_blank">Acquista i biglietti</a>
                        `;
                        
                        // Aggiungi il marker per ogni evento
                        var marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(popupContent);
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei dati: ', error);
                    alert('Errore nel caricamento dei dati. Controlla la console per maggiori dettagli.');
                });
        }

        // Funzione per convertire il CSV in un array di oggetti
        function csvToArray(strData, strDelimiter = ",") {
            var objPattern = new RegExp(
                (
                    // Delimitatori
                    "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

                    // I valori
                    "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
                    "([^\"\\" + strDelimiter + "\\r\\n]*))"
                ), "gi"
            );

            var arrData = [[]];
            var arrMatches = null;
            while (arrMatches = objPattern.exec(strData)) {
                var strMatchedDelimiter = arrMatches[1];
                var strMatchedValue = arrMatches[2] ? arrMatches[2] : arrMatches[3];
                if (strMatchedDelimiter.length && strMatchedDelimiter !== strDelimiter) {
                    arrData.push([]);
                }
                arrData[arrData.length - 1].push(strMatchedValue);
            }

            return arrData.slice(1).map(row => {
                return {
                    "Nome Evento": row[0],
                    "Indirizzo": row[1],
                    "Latitudine": row[2],
                    "Longitudine": row[3],
                    "Descrizione": row[4],
                    "Link Biglietti": row[5],
                    "Data Evento": row[6]
                };
            });
        }

        // Carica i dati dal CSV
        fetchData();
    </script>

</body>
</html>

